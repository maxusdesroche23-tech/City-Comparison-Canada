---
title: "City Comparison Dashboard – Income & Rent (2021)"
author: "Max Desroches"
date: "`r format(Sys.Date(), '%Y-%m-%d')`"
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: false
    theme: flatly
    highlight: tango
    df_print: paged
    code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.width = 10,
  fig.height = 5.5,
  fig.retina = 2
)

library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(forcats)
library(stringr)
library(here)
library(scales)

# ---- Project scripts ----
source(here("scripts", "utils.R"))
source(project_path("scripts", "load_data.R"))

if (file.exists(project_path("scripts", "cleaning.R")))
  source(project_path("scripts", "cleaning.R"))
if (file.exists(project_path("scripts", "transform.R")))
  source(project_path("scripts", "transform.R"))
if (file.exists(project_path("scripts", "plotting.R")))
  source(project_path("scripts", "plotting.R"))

# ---- Formatting helpers (CAD) ----
cad0 <- label_dollar(prefix = "$", big.mark = ",", accuracy = 1)       # $1,234
cadK <- label_dollar(prefix = "$", big.mark = ",", accuracy = 1, scale = 1e-3, suffix = "K")  # $65K
pct1 <- label_percent(accuracy = 0.1)

# ---- Dashboard theme (modern / portfolio) ----
theme_set(theme_minimal(base_size = 12))

dashboard_theme <- function() {
  theme(
    plot.title = element_text(face = "bold", size = 16, margin = margin(b = 6)),
    plot.subtitle = element_text(size = 11, color = "gray25", margin = margin(b = 10)),
    plot.caption = element_text(size = 9, color = "gray40", margin = margin(t = 10)),
    axis.title = element_text(face = "bold"),
    axis.text = element_text(color = "gray20"),
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank(),
    legend.position = "bottom"
  )
}

# ---- Simple "card" look for key metrics (HTML) ----
card_css <- "
<style>
  .cards { display:flex; gap:14px; flex-wrap:wrap; margin: 10px 0 16px 0; }
  .card  { background:#ffffff; border:1px solid #e9ecef; border-radius:14px;
           padding:14px 16px; min-width:220px; box-shadow: 0 6px 18px rgba(0,0,0,0.04); }
  .kpi   { font-size:22px; font-weight:700; margin: 0; }
  .lbl   { font-size:12px; color:#6c757d; margin: 0; }
  .note  { font-size:12px; color:#6c757d; margin-top:6px; }
</style>
"
```

# Overview
This dashboard summarizes income vs rent patterns across cities and creates a simple affordability ranking using a rent-to-income ratio.

Data loading
income_raw <- load_income_data("income_2021.csv")
rent_raw   <- load_rent_data("rent_2021.csv")

glimpse(income_raw)
glimpse(rent_raw)

cat("Rows in income:", nrow(income_raw), "\n")
cat("Rows in rent  :", nrow(rent_raw), "\n")

Data prep
income_clean <- clean_income_data(income_raw)
rent_clean   <- clean_rent_data(rent_raw)

city_df <- combine_income_rent(income_clean, rent_clean)

# Affordability metric
city_df <- city_df |>
mutate(
rent_to_income_ratio = (avg_monthly_rent_2021 * 12) / median_income_2021
)

# Rankings
city_rank <- city_df |>
filter(!is.na(rent_to_income_ratio)) |>
arrange(rent_to_income_ratio) |>
mutate(affordability_rank = row_number())

top_10 <- city_rank |> slice_min(rent_to_income_ratio, n = 10)
bottom_10 <- city_rank |> slice_max(rent_to_income_ratio, n = 10)

# Correlation
cor_income_rent <- cor(
city_df$median_income_2021,
city_df$avg_monthly_rent_2021,
use = "complete.obs"
)
n_cities <- nrow(city_rank)
med_income <- median(city_rank$median_income_2021, na.rm = TRUE)
med_rent <- median(city_rank$avg_monthly_rent_2021, na.rm = TRUE)
med_ratio <- median(city_rank$rent_to_income_ratio, na.rm = TRUE)

cat('<div class="cards">')
cat(sprintf('<div class="card"><p class="lbl">Cities analyzed</p><p class="kpi">%s</p><p class="note">After cleaning & matching</p></div>',
comma(n_cities)))
cat(sprintf('<div class="card"><p class="lbl">Median income (2021)</p><p class="kpi">%s</p><p class="note">Assumed CAD</p></div>',
dollar(med_income, prefix="$", big.mark=",", accuracy=1)))
cat(sprintf('<div class="card"><p class="lbl">Median rent / month (2021)</p><p class="kpi">%s</p><p class="note">Assumed CAD</p></div>',
dollar(med_rent, prefix="$", big.mark=",", accuracy=1)))
cat(sprintf('<div class="card"><p class="lbl">Median rent-to-income</p><p class="kpi">%s</p><p class="note">Lower is better</p></div>',
percent(med_ratio, accuracy=0.1)))
cat('</div>')

Distributions
Income distribution

ggplot(city_rank, aes(x = median_income_2021)) +
geom_histogram(bins = 30) +
scale_x_continuous(labels = cadK) +
labs(
title = "Income distribution",
subtitle = "Median city income (2021) — shown in CAD, scaled to thousands",
x = "Median income (CAD, thousands)",
y = "Number of cities",
caption = "City-Comparison-Canada project data"
) +
dashboard_theme()

# Rent distribution
ggplot(city_rank, aes(x = avg_monthly_rent_2021)) +
geom_histogram(bins = 30) +
scale_x_continuous(labels = cad0) +
labs(
title = "Rent distribution",
subtitle = "Average monthly rent (2021) — CAD",
x = "Average monthly rent (CAD)",
y = "Number of cities",
caption = "City-Comparison-Canada project data"
) +
dashboard_theme()

Relationship: income vs rent

ggplot(city_rank, aes(x = median_income_2021, y = avg_monthly_rent_2021)) +
geom_point(alpha = 0.65, size = 2) +
geom_smooth(method = "lm", se = TRUE) +
scale_x_continuous(labels = cadK) +
scale_y_continuous(labels = cad0) +
labs(
title = "Income vs rent (by city)",
subtitle = paste0("Trend line (linear model). Correlation: ", round(cor_income_rent, 3)),
x = "Median income (CAD, thousands)",
y = "Average monthly rent (CAD)",
caption = "Correlation computed using complete observations"
) +
dashboard_theme()

# Affordability ranking
We define **affordability** using the following metric:

$$
\text{Rent-to-income ratio} =
\frac{\text{Monthly rent} \times 12}{\text{Annual income}}
$$

**Interpretation**

- Lower values indicate **better affordability**
- Higher values indicate **worse affordability**

---

## Top 10 most affordable cities
  
  top_10 |>
mutate(city = fct_reorder(city, rent_to_income_ratio)) |>
ggplot(aes(x = city, y = rent_to_income_ratio)) +
geom_col() +
geom_text(
aes(label = percent(rent_to_income_ratio, accuracy = 0.1)),
hjust = -0.05, size = 3.3
) +
coord_flip(clip = "off") +
scale_y_continuous(labels = pct1, expand = expansion(mult = c(0, 0.15))) +
labs(
title = "Top 10 most affordable cities",
subtitle = "Lower rent-to-income ratio is better",
x = NULL,
y = "Rent-to-income ratio",
caption = "Metric: (avg_monthly_rent_2021 * 12) / median_income_2021"
) +
dashboard_theme()

## Top 10 least affordable

bottom_10 |>
mutate(city = fct_reorder(city, rent_to_income_ratio)) |>
ggplot(aes(x = city, y = rent_to_income_ratio)) +
geom_col() +
geom_text(
aes(label = percent(rent_to_income_ratio, accuracy = 0.1)),
hjust = -0.05, size = 3.3
) +
coord_flip(clip = "off") +
scale_y_continuous(labels = pct1, expand = expansion(mult = c(0, 0.15))) +
labs(
title = "Top 10 least affordable cities",
subtitle = "Higher rent-to-income ratio is worse",
x = NULL,
y = "Rent-to-income ratio",
caption = "Metric: (avg_monthly_rent_2021 * 12) / median_income_2021"
) +
dashboard_theme()

Tables (optional)

city_rank |>
select(affordability_rank, city, median_income_2021, avg_monthly_rent_2021, rent_to_income_ratio) |>
mutate(
median_income_2021 = dollar(median_income_2021, prefix="$", big.mark=",", accuracy=1),
avg_monthly_rent_2021 = dollar(avg_monthly_rent_2021, prefix="$", big.mark=",", accuracy=1),
rent_to_income_ratio = percent(rent_to_income_ratio, accuracy=0.1)
) |>
head(20)

# Saving outputs
# Save cleaned dataset
output_path <- project_path("data", "city_income_rent_clean.csv")
readr::write_csv(city_rank, output_path)

# Save key plots (if your plotting.R has helpers)
income_rent_plot_path <- project_path("visuals", "income_vs_rent.png")
affordability_plot_path <- project_path("visuals", "affordability_top10.png")

save_income_vs_rent_plot(city_rank, income_rent_plot_path)
save_affordability_plot(top_10, affordability_plot_path)

# Conclusion
This analysis examined the relationship between **city-level income and rent** across selected Canadian cities using 2021 data.

The results show a **strong positive relationship** between income and rent, indicating that cities with higher median incomes also tend to have higher housing costs. However, income growth does not fully offset rent increases in all locations, leading to meaningful differences in **housing affordability**.

Using the **rent-to-income ratio** as an affordability metric highlights clear contrasts between cities. Mid-sized cities such as **Quebec City, Calgary, and Edmonton** appear more affordable, while larger metropolitan areas like **Toronto and Vancouver** rank among the least affordable.

Overall, this analysis demonstrates how simple, transparent metrics can provide valuable insights into cost-of-living differences across cities. The framework can be extended in future work by incorporating additional variables such as population growth, labor market indicators, or multi-year trends to support deeper policy or investment analysis.



